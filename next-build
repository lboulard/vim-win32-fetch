#!/bin/bash

set -eu
set pipefail

DEADLINE="${XDG_STATE_HOME:-$HOME/.local/state}/vim-win32-deadline"

# Set 9 hours as IDLE time after last commit
IDLE=$((9 * 60 * 60))

now="$(date --utc +%s)"
vimbuild() {
  "$HOME/.local/bin/vimbuild" || echo 0 failed "$(date -d "@$now")"
}

# arguments: 12:00 epoch_utc
time_before() {
  local seconds
  test -n "$1" && test -n "$2"
  limit="$(date -d "1970-01-01 UTC $(TZ=Europe/Paris date +%T -d "$1")" +%s)"
  since_midnight="$(date -d "1970-01-01 UTC $(TZ=Europe/Paris date +%T -d "@$2")" +%s)"
  [[ "$since_midnight" -lt "$limit" ]]
}

read -t 15 -r delta tag updated < <(vimbuild)
printf "last tag %s at %s\n" "$tag" "$updated"
if [[ "$delta" -ge "$IDLE" ]]; then
  "$HOME/fetch-vim-win32" "$tag" 2>&1 | tee -a "$HOME/vim-win32-build.log" |
    while read -r line; do
      printf "%s> %s\n" "vim-win32" "$line"
    done
else
  # run again $IDLE time after latest commit
  next=$((now + IDLE - delta))
  # never run after 12:00 in Europe/Paris time zone
  if time_before 12:00 "$next"; then
    echo too early, will retry at "$next"
    mkdir -p "${DEADLINE%/*}"
    echo "$next" >"$DEADLINE"
  else
    echo next try at midnight, too late at "$next"
  fi
fi
